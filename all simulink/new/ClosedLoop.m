global Delta dt ddq_max dq_Max K1 K2 K3 rho_11 rho_12 rho_31 rho_32 nodes Tau11 Tau12 eta1 b c
% 1)基本设置
Delta=2*pi/2^19; % 编码器
dt=0.0005; % 仿真步长，单位：秒
ddq_max=pi; dq_Max=3; 
% 2)控制器增益
k13=15;k14=15;    k23=1;k24=1;    k33=100;k34=100;
K1=[k13;k14];     K2=[k23;k24];   K3=[k33;k34];
K1=diag(K1);      K2=diag(K2);    K3=diag(K3);
% 3)双环BLF
rho_13=.008;rho_14=.008;  rho_33=.5;rho_34=.5;
rho_11=rho_13;rho_12=rho_14;  rho_31=rho_33;rho_32=rho_34;
% 4)RBFNN            
nodes=13;  Tau11=60;Tau12=60;  eta1=0.01;  b=60;
c=[-30 -25 -20 -15 -10 -5 0 5 10 15 20 25 30;
   -30 -25 -20 -15 -10 -5 0 5 10 15 20 25 30];

% Initialization
Number_All=60001;Number_Major=12001;T_final=30;
count=1;i=1;T=0;q=[0.005;-0.005];dq=[-0.1705;0.1576];Weights=zeros(2*nodes,1);z=[0;0;0;0;0;0];
%数据存储
Data_SS_Log=zeros(60001,4);Data_Tau_Log=zeros(Number_Major,2);

%% main function
while count<=Number_All   % 60001 or 60000?
        count
        Data_SS_Log(count,1:2)=[q(1) q(2)]; % 数据存储
        Data_SS_Log(count,3:4)=[dq(1) dq(2)]; % 数据存储 
        if rem(count-1,5)==0 % MajorSteps
                q_sample = Encoder(q);
                Torque = Controller(Weights,0,0,qd3(i),qd4(i),dqd3(i),dqd4(i),ddqd3(i),ddqd4(i),q_sample,q,dq);
%                 Torque_OtherSteps = Torque;
                dq_OtherSteps = dq;
                Weights = Dynamics_W(Weights,0,0,qd3(i),qd4(i),dqd3(i),dqd4(i),q_sample,dq);
                ddq = Dynamics_ddq(Torque,q,dq,z);
                z = Dynamics_z(dq,z);
                dq = Dynamics_dq(ddq,dq);
                q = Dynamics_q(dq,q);
                Data_Tau_Log(i,1:2)=[Torque(3) Torque(4)];
                i=i+1;   % i的终止值是12001
        else
                Weights = Dynamics_W(Weights,0,0,qd3(i-1),qd4(i-1),dqd3(i-1),dqd4(i-1),q_sample,dq_OtherSteps);
                ddq = Dynamics_ddq(Torque,q,dq,z);
                z = Dynamics_z(dq,z);
                dq = Dynamics_dq(ddq,dq);
                q = Dynamics_q(dq,q);
        end
        T=T+dt;  % 实际时间
        count=count+1;
end

t1=0:dt:T_final;t2=0:5*dt:T_final;
figure(1);
subplot(221);plot(t2,qd3,'k',t1,Data_SS_Log(:,1),'g--','linewidth',1.0);hold on;
subplot(222);plot(t2,qd4,'k',t1,Data_SS_Log(:,2),'g--','linewidth',1.0);hold on;
subplot(223);plot(t2,dqd3,'k',t1,Data_SS_Log(:,3),'g--','linewidth',1.0);hold on;
subplot(224);plot(t2,dqd4,'k',t1,Data_SS_Log(:,4),'g--','linewidth',1.0);hold on;
q3_12001=zeros(Number_Major,1);q4_12001=zeros(Number_Major,1);dq3_12001=zeros(Number_Major,1);dq4_12001=zeros(Number_Major,1);
for j=1:1:Number_Major
    q3_12001(j)=Data_SS_Log(5*(j-1)+1,1);
    q4_12001(j)=Data_SS_Log(5*(j-1)+1,2);
    dq3_12001(j)=Data_SS_Log(5*(j-1)+1,3);
    dq4_12001(j)=Data_SS_Log(5*(j-1)+1,4);
end
figure(2);
subplot(221);plot(t2,abs(qd3-q3_12001)*180/pi,'g','linewidth',1.0);hold on;
subplot(222);plot(t2,abs(qd4-q4_12001)*180/pi,'g','linewidth',1.0);hold on;
subplot(223);plot(t2,abs(dqd3-dq3_12001),'g','linewidth',1.0);hold on;
subplot(224);plot(t2,abs(dqd4-dq4_12001),'g','linewidth',1.0);hold on;
figure(3);
subplot(221);plot(t2,Data_Tau_Log(:,1),'g','linewidth',1.0);hold on;
subplot(222);plot(t2,Data_Tau_Log(:,2),'g','linewidth',1.0);hold on;

%% 加速度求解
function ddq_out = Dynamics_ddq(Torque,q,dq,z)
global ddq_max
q3=q(1); q4=q(2); dq3=dq(1); dq4=dq(2);
% 一、M
M11 = (3932438768524053*cos(q4))/590295810358705651712 - (9666515293019412421*sin(2*q3 + q4))/147573952589676412928 - (7347855351585683*cos(2*q3))/18014398509481984 - (36945533070432904259*cos(2*q3 + 2*q4))/2361183241434822606848 - (2242006792538445303*sin(2*q3 + 2*q4))/1208925819614629174706176 - (3932438768524053*cos(2*q3 + q4))/590295810358705651712 + (9666515293019412421*sin(q4))/147573952589676412928 + 6993021903434165153791/9444732965739290427392;
M12 = (1566193994333460609165*cos(q3 + q4 + pi/2))/75557863725914323419136 - (260291698974264027*sin(q3 + q4 + pi/2))/151115727451828646838272 - (158738597992664517*sin(q3 + pi/2))/1152921504606846976 - 23750155206264607/144115188075855872;
M13 = (1566193994333460609165*cos(q3 + q4 + pi/2))/75557863725914323419136 - (260291698974264027*sin(q3 + q4 + pi/2))/151115727451828646838272 - (158738597992664517*sin(q3 + pi/2))/1152921504606846976;
M14 = (1566193994333460609165*cos(q3 + q4 + pi/2))/75557863725914323419136 - (260291698974264027*sin(q3 + q4 + pi/2))/151115727451828646838272;
M15 = - (3951197109736239241155*cos(q3 + q4 + pi/2))/75557863725914323419136 - (2242006792538445279*sin(q3 + q4 + pi/2))/1208925819614629174706176 - (3932438768524053*cos(q3 + pi/2))/590295810358705651712 - 2364964252341131/5316911983139663491615228241121378304;
M16 = (392149993849384621*cos(q3 + q4 + pi/2))/75557863725914323419136 - (260291698974264035*sin(q3 + q4 + pi/2))/151115727451828646838272;
M22 = (6599725983735443*cos(q3))/4503599627370496 + (3932438768524053*cos(q4))/295147905179352825856 + (9666515293019412421*sin(q4))/73786976294838206464 + (8575983760191473*cos(q3)*cos(q4))/590295810358705651712 + (21081034709077362555*cos(q3)*sin(q4))/147573952589676412928 + (21081034709077362555*cos(q4)*sin(q3))/147573952589676412928 - (8575983760191473*sin(q3)*sin(q4))/590295810358705651712 + 802526512685661487937/295147905179352825856;
M23 = (6599725983735443*cos(q3))/9007199254740992 + (3932438768524053*cos(q4))/295147905179352825856 + (9666515293019412421*sin(q4))/73786976294838206464 + (8575983760191473*cos(q3)*cos(q4))/1180591620717411303424 + (21081034709077362555*cos(q3)*sin(q4))/295147905179352825856 + (21081034709077362555*cos(q4)*sin(q3))/295147905179352825856 - (8575983760191473*sin(q3)*sin(q4))/1180591620717411303424 + 292870962545184539457/295147905179352825856;
M24 = (3932438768524053*cos(q4))/590295810358705651712 + (9666515293019412421*sin(q4))/147573952589676412928 + (8575983760191473*cos(q3)*cos(q4))/1180591620717411303424 + (21081034709077362555*cos(q3)*sin(q4))/295147905179352825856 + (21081034709077362555*cos(q4)*sin(q3))/295147905179352825856 - (8575983760191473*sin(q3)*sin(q4))/1180591620717411303424 + 36296309188291035969/295147905179352825856;
M25 = (2230692869490939*sin(q4))/1152921504606846976 + (304047738388393*cos(q3)*sin(q4))/144115188075855872 + (304047738388393*cos(q4)*sin(q3))/144115188075855872 + 315508820003156273/2361183241434822606848;
M26 = (3932438768524053*cos(q4))/590295810358705651712 + (2962264730236869*sin(q4))/147573952589676412928 + (8575983760191473*cos(q3)*cos(q4))/1180591620717411303424 + (6460198293038971*cos(q3)*sin(q4))/295147905179352825856 + (6460198293038971*cos(q4)*sin(q3))/295147905179352825856 - (8575983760191473*sin(q3)*sin(q4))/1180591620717411303424 + 29720514162674078529/590295810358705651712;
M33 = (3932438768524053*cos(q4))/295147905179352825856 + (9666515293019412421*sin(q4))/73786976294838206464 + 292870962545184539457/295147905179352825856;
M34 = (3932438768524053*cos(q4))/590295810358705651712 + (9666515293019412421*sin(q4))/147573952589676412928 + 36296309188291035969/295147905179352825856;
M35 = (2230692869490939*sin(q4))/1152921504606846976 + 315508820003156273/2361183241434822606848;
M36 = (3932438768524053*cos(q4))/590295810358705651712 + (2962264730236869*sin(q4))/147573952589676412928 + 29720514162674078529/590295810358705651712;
M44 = 0.1230;
M45 = 1.3362e-04;
M46 = 0.0503;
M55 = 0.0529;
M56 = 1.2030e-06;
M66 = 0.0503;
M_66 = [M11 M12 M13 M14 M15 M16;
        M12 M22 M23 M24 M25 M26;   
        M13 M23 M33 M34 M35 M36;   
        M14 M24 M34 M44 M45 M46;   
        M15 M25 M35 M45 M55 M56;   
        M16 M26 M36 M46 M56 M66];

% 二、C
C1 = (158738597992664517*dq3^2*sin(q3))/1152921504606846976 - (788574876594818524558499406425187*dq3^2*cos(q3))/93536104789177786765035829293842113257979682750464 - (31766188111850551462598880893467128091902779047347567*dq3^2*cos(q3)*cos(q4))/1532495540865888858358347027150309183618739122183602176 - (31766188111850551462598880893467128091902779047347567*dq4^2*cos(q3)*cos(q4))/1532495540865888858358347027150309183618739122183602176 + (329958928438908233217359294665525876989291241165*dq3^2*cos(q3)*sin(q4))/191561942608236107294793378393788647952342390272950272 + (329958928438908233217359294665525876989291241165*dq3^2*cos(q4)*sin(q3))/191561942608236107294793378393788647952342390272950272 + (329958928438908233217359294665525876989291241165*dq4^2*cos(q3)*sin(q4))/191561942608236107294793378393788647952342390272950272 + (329958928438908233217359294665525876989291241165*dq4^2*cos(q4)*sin(q3))/191561942608236107294793378393788647952342390272950272 + (31766188111850551462598880893467128091902779047347567*dq3^2*sin(q3)*sin(q4))/1532495540865888858358347027150309183618739122183602176 + (31766188111850551462598880893467128091902779047347567*dq4^2*sin(q3)*sin(q4))/1532495540865888858358347027150309183618739122183602176 - (31766188111850551296445381420352643978926896512304495*dq3*dq4*cos(q3)*cos(q4))/766247770432944429179173513575154591809369561091801088 + (329958928438908233217359294666797622934896747981*dq3*dq4*cos(q3)*sin(q4))/95780971304118053647396689196894323976171195136475136 + (329958928438908233217359294666797622934896747981*dq3*dq4*cos(q4)*sin(q3))/95780971304118053647396689196894323976171195136475136 + (31766188111850551296445381420352643978926896512304495*dq3*dq4*sin(q3)*sin(q4))/766247770432944429179173513575154591809369561091801088;
C2 = (9666515293019412421*dq4^2*cos(q4))/147573952589676412928 - (3932438768524053*dq4^2*sin(q4))/590295810358705651712 - (6599725983735443*dq3^2*sin(q3))/9007199254740992 - (3932438768524053*dq3*dq4*sin(q4))/295147905179352825856 + (21081034709077362555*dq3^2*cos(q3)*cos(q4))/295147905179352825856 + (21081034709077362555*dq4^2*cos(q3)*cos(q4))/295147905179352825856 - (8575983760191473*dq3^2*cos(q3)*sin(q4))/1180591620717411303424 - (8575983760191473*dq3^2*cos(q4)*sin(q3))/1180591620717411303424 - (8575983760191473*dq4^2*cos(q3)*sin(q4))/1180591620717411303424 - (8575983760191473*dq4^2*cos(q4)*sin(q3))/1180591620717411303424 - (21081034709077362555*dq3^2*sin(q3)*sin(q4))/295147905179352825856 - (21081034709077362555*dq4^2*sin(q3)*sin(q4))/295147905179352825856 + (9666515293019412421*dq3*dq4*cos(q4))/73786976294838206464 + (21081034709077362555*dq3*dq4*cos(q3)*cos(q4))/147573952589676412928 - (8575983760191473*dq3*dq4*cos(q3)*sin(q4))/590295810358705651712 - (8575983760191473*dq3*dq4*cos(q4)*sin(q3))/590295810358705651712 - (21081034709077362555*dq3*dq4*sin(q3)*sin(q4))/147573952589676412928;
C3 = (9666515293019412421*dq4^2*cos(q4))/147573952589676412928 - (3932438768524053*dq4^2*sin(q4))/590295810358705651712 - (3932438768524053*dq3*dq4*sin(q4))/295147905179352825856 + (9666515293019412421*dq3*dq4*cos(q4))/73786976294838206464;
C4 = (3932438768524053*dq3^2*sin(q4))/590295810358705651712 - (9666515293019412421*dq3^2*cos(q4))/147573952589676412928;
C5 = - (7541740619071967*dq3*dq4)/9444732965739290427392 - (7541740619071967*dq3^2)/18889465931478580854784 - (7541740619071967*dq4^2)/18889465931478580854784 - (2230692869490939*dq3^2*cos(q4))/1152921504606846976;
C6 = (3932438768524053*dq3^2*sin(q4))/590295810358705651712 + (4369139136790775*dq3*dq4)/1180591620717411303424 + (4369139136790775*dq3^2)/2361183241434822606848 + (4369139136790775*dq4^2)/2361183241434822606848 - (2962264730236869*dq3^2*cos(q4))/147573952589676412928;
C=[C1;C2;C3;C4;C5;C6]; 

% 三、G
G1 = 0; 
G2 = (817603655937935*cos(q3 + q4 + pi/2))/4611686018427387904 + (10048952709718828759483*sin(q3 + q4 + pi/2))/5764607523034234880000 + (12583885985274322167*cos(q3 + pi/2))/703687441776640000 + 10874744537588643/5070602400912917605986812821504;
G3 = (12583885985274322167*cos(q3 + pi/2))/703687441776640000 + (817603655937935*cos(q4)*cos(q3 + pi/2))/4611686018427387904 + (10048952709718828759483*cos(q4)*sin(q3 + pi/2))/5764607523034234880000 + (10048952709718828759483*cos(q3 + pi/2)*sin(q4))/5764607523034234880000 - (817603655937935*sin(q4)*sin(q3 + pi/2))/4611686018427387904;
G4 = (817603655937935*cos(q4)*cos(q3 + pi/2))/4611686018427387904 + (10048952709718828759483*cos(q4)*sin(q3 + pi/2))/5764607523034234880000 + (10048952709718828759483*cos(q3 + pi/2)*sin(q4))/5764607523034234880000 - (817603655937935*sin(q4)*sin(q3 + pi/2))/4611686018427387904;
G5 = (11873003616788183147*sin(q3 + q4 + pi/2))/230584300921369395200;
G6 = (817603655937935*cos(q3 + q4 + pi/2))/4611686018427387904 + (4927137821310187*sin(q3 + q4 + pi/2))/9223372036854775808;
G=[G1;G2;G3;G4;G5;G6]; 

% 四、F
z3=z(3); z4=z(4);
% dz1 = 0;
% dz2 = 0;
dz3 = (32880603970571302491146779030281*dq3*atan(1000*dq3)^2)/81129638414606681695789005144064 - (13366329615528018129*dq3*z3*atan(1000*dq3))/(1801439850948198400*((6177572351796469*atan((5734161139222659*dq3*atan(1000*dq3))/90071992547409920))/144115188075855872 + 1003/2500));
dz4 = (32880603970571302491146779030281*dq4*atan(1000*dq4)^2)/81129638414606681695789005144064 - (13366329615528018129*dq4*z4*atan(1000*dq4))/(1801439850948198400*((6177572351796469*atan((5734161139222659*dq4*atan(1000*dq4))/90071992547409920))/144115188075855872 + 1003/2500));
% dz5 = 0;
% dz6 = 0;
% dz=[dz1;dz2;dz3;dz4;dz5;dz6]; 
F1 = 0;
F2 = 0;
F3 = (797302866510865*dq3)/288230376151711744 + (14749*dz3)/2500 + (2331*z3)/200 - (20755908149554467968595694231197*dq3^2*atan(1000*dq3))/21267647932558653966460912964485513216;
F4 = (797302866510865*dq4)/288230376151711744 + (14749*dz4)/2500 + (2331*z4)/200 - (20755908149554467968595694231197*dq4^2*atan(1000*dq4))/21267647932558653966460912964485513216;
F4 = 1/5 * F4;
F5 = 0;
F6 = 0;
F=[F1;F2;F3;F4;F5;F6];

% 五、ddq
ddq = M_66 \ (Torque-C-G-F);
for i=3:1:4
    if ddq(i)>ddq_max
        ddq(i)=ddq_max;
    elseif ddq(i)<-ddq_max
        ddq(i)=-ddq_max;
    end
end
ddq_out=[ddq(3);ddq(4)];
end

%% 鬃毛变量求解
function z = Dynamics_z(dq,z)
global dt
z3=z(3); z4=z(4);   dq3=dq(1); dq4=dq(2);
dz1 = 0;
dz2 = 0;
dz3 = (32880603970571302491146779030281*dq3*atan(1000*dq3)^2)/81129638414606681695789005144064 - (13366329615528018129*dq3*z3*atan(1000*dq3))/(1801439850948198400*((6177572351796469*atan((5734161139222659*dq3*atan(1000*dq3))/90071992547409920))/144115188075855872 + 1003/2500));
dz4 = (32880603970571302491146779030281*dq4*atan(1000*dq4)^2)/81129638414606681695789005144064 - (13366329615528018129*dq4*z4*atan(1000*dq4))/(1801439850948198400*((6177572351796469*atan((5734161139222659*dq4*atan(1000*dq4))/90071992547409920))/144115188075855872 + 1003/2500));
dz5 = 0;
dz6 = 0;
dz=[dz1;dz2;dz3;dz4;dz5;dz6];
z=z+dz*dt;
end

%% 速度求解
function dq_out = Dynamics_dq(ddq,dq)
global dt dq_Max
dq=dq+ddq*dt;
for i=1:1:2
    if dq(i)>dq_Max
        dq(i)=dq_Max;
    elseif dq(i)<-dq_Max
        dq(i)=-dq_Max;
    end
end
dq_out=[dq(1);dq(2)];
end

%% 位置求解
function q_out = Dynamics_q(dq,q)
global dt
q_out=q+dq*dt;
end

%% 传感器
function q_sample = Encoder(q)
global Delta
q_sample=[0;0];
for i=1:1:2
    Number=floor(q(i)/Delta)+1;
    q_sample(i)=Number*Delta;
end
end

%% 控制力矩计算
function Tau = Controller(W,e13_com,e14_com,qd3,qd4,dqd3,dqd4,ddqd3,ddqd4,sq,q,dq)
global K1 K2 K3 rho_11 rho_12 rho_31 rho_32 nodes b c

% 二、系统输入
e1_com=[e13_com;e14_com];
qd=[qd3;qd4]; 
dqd=[dqd3;dqd4];
ddqd=[ddqd3;ddqd4];

% 四、误差信号
e1=sq-qd;
% e1=q-(qd-.5*e1_com); % OK
de1=dq-dqd;

% 五、虚拟控制器
miu=-K1*e1+dqd;
dmiu=-K1*de1+ddqd;

% 六、辅助误差信号
e2=dq-miu;
e3=K2*e1+e2;

% 七、双环BLF
%     1)外环
            u_BLF1=[e1(1)/(rho_11^2-e1(1)^2);
                    e1(2)/(rho_12^2-e1(2)^2)];     % u_BLF1：2行1列
%     2)内环
            u_BLF2_denominator_1=rho_31^2-e3(1)^2;
            u_BLF2_denominator_2=rho_32^2-e3(2)^2;
            u_BLF2=[e3(1)/u_BLF2_denominator_1;
                    e3(2)/u_BLF2_denominator_2];   % u_BLF2：2行1列
            Gain_3=diag([u_BLF2_denominator_1;u_BLF2_denominator_2]);

% 八、RBFNN
%     1)RBF Kernel 
            xi1=[sq(1);dq(1)];xi2=[sq(2);dq(2)];
            h1=zeros(nodes,1);h2=zeros(nodes,1);
            for j=1:1:nodes
                h1(j)=exp(-norm(xi1-c(:,j))^2/(b*b));
                h2(j)=exp(-norm(xi2-c(:,j))^2/(b*b));
            end
%      2)estimate
            W1=W(1:nodes,1);W2=W(nodes+1:2*nodes,1);
            fn=[W1'*h1;W2'*h2];

% 九、真实控制器
%     1) 6行6列的模型矩阵
            q3=q(1);q4=q(2);
            M11 = (3932438768524053*cos(q4))/590295810358705651712 - (9666515293019412421*sin(2*q3 + q4))/147573952589676412928 - (7347855351585683*cos(2*q3))/18014398509481984 - (36945533070432904259*cos(2*q3 + 2*q4))/2361183241434822606848 - (2242006792538445303*sin(2*q3 + 2*q4))/1208925819614629174706176 - (3932438768524053*cos(2*q3 + q4))/590295810358705651712 + (9666515293019412421*sin(q4))/147573952589676412928 + 6993021903434165153791/9444732965739290427392;
            M12 = (1566193994333460609165*cos(q3 + q4 + pi/2))/75557863725914323419136 - (260291698974264027*sin(q3 + q4 + pi/2))/151115727451828646838272 - (158738597992664517*sin(q3 + pi/2))/1152921504606846976 - 23750155206264607/144115188075855872;
            M13 = (1566193994333460609165*cos(q3 + q4 + pi/2))/75557863725914323419136 - (260291698974264027*sin(q3 + q4 + pi/2))/151115727451828646838272 - (158738597992664517*sin(q3 + pi/2))/1152921504606846976;
            M14 = (1566193994333460609165*cos(q3 + q4 + pi/2))/75557863725914323419136 - (260291698974264027*sin(q3 + q4 + pi/2))/151115727451828646838272;
            M15 = - (3951197109736239241155*cos(q3 + q4 + pi/2))/75557863725914323419136 - (2242006792538445279*sin(q3 + q4 + pi/2))/1208925819614629174706176 - (3932438768524053*cos(q3 + pi/2))/590295810358705651712 - 2364964252341131/5316911983139663491615228241121378304;
            M16 = (392149993849384621*cos(q3 + q4 + pi/2))/75557863725914323419136 - (260291698974264035*sin(q3 + q4 + pi/2))/151115727451828646838272;
            M22 = (6599725983735443*cos(q3))/4503599627370496 + (3932438768524053*cos(q4))/295147905179352825856 + (9666515293019412421*sin(q4))/73786976294838206464 + (8575983760191473*cos(q3)*cos(q4))/590295810358705651712 + (21081034709077362555*cos(q3)*sin(q4))/147573952589676412928 + (21081034709077362555*cos(q4)*sin(q3))/147573952589676412928 - (8575983760191473*sin(q3)*sin(q4))/590295810358705651712 + 802526512685661487937/295147905179352825856;
            M23 = (6599725983735443*cos(q3))/9007199254740992 + (3932438768524053*cos(q4))/295147905179352825856 + (9666515293019412421*sin(q4))/73786976294838206464 + (8575983760191473*cos(q3)*cos(q4))/1180591620717411303424 + (21081034709077362555*cos(q3)*sin(q4))/295147905179352825856 + (21081034709077362555*cos(q4)*sin(q3))/295147905179352825856 - (8575983760191473*sin(q3)*sin(q4))/1180591620717411303424 + 292870962545184539457/295147905179352825856;
            M24 = (3932438768524053*cos(q4))/590295810358705651712 + (9666515293019412421*sin(q4))/147573952589676412928 + (8575983760191473*cos(q3)*cos(q4))/1180591620717411303424 + (21081034709077362555*cos(q3)*sin(q4))/295147905179352825856 + (21081034709077362555*cos(q4)*sin(q3))/295147905179352825856 - (8575983760191473*sin(q3)*sin(q4))/1180591620717411303424 + 36296309188291035969/295147905179352825856;
            M25 = (2230692869490939*sin(q4))/1152921504606846976 + (304047738388393*cos(q3)*sin(q4))/144115188075855872 + (304047738388393*cos(q4)*sin(q3))/144115188075855872 + 315508820003156273/2361183241434822606848;
            M26 = (3932438768524053*cos(q4))/590295810358705651712 + (2962264730236869*sin(q4))/147573952589676412928 + (8575983760191473*cos(q3)*cos(q4))/1180591620717411303424 + (6460198293038971*cos(q3)*sin(q4))/295147905179352825856 + (6460198293038971*cos(q4)*sin(q3))/295147905179352825856 - (8575983760191473*sin(q3)*sin(q4))/1180591620717411303424 + 29720514162674078529/590295810358705651712;
            M33 = (3932438768524053*cos(q4))/295147905179352825856 + (9666515293019412421*sin(q4))/73786976294838206464 + 292870962545184539457/295147905179352825856;
            M34 = (3932438768524053*cos(q4))/590295810358705651712 + (9666515293019412421*sin(q4))/147573952589676412928 + 36296309188291035969/295147905179352825856;
            M35 = (2230692869490939*sin(q4))/1152921504606846976 + 315508820003156273/2361183241434822606848;
            M36 = (3932438768524053*cos(q4))/590295810358705651712 + (2962264730236869*sin(q4))/147573952589676412928 + 29720514162674078529/590295810358705651712;
            M44 = 0.1230;
            M45 = 1.3362e-04;
            M46 = 0.0503;
            M55 = 0.0529;
            M56 = 1.2030e-06;
            M66 = 0.0503;
            M_66 = [M11 M12 M13 M14 M15 M16;
                    M12 M22 M23 M24 M25 M26;   
                    M13 M23 M33 M34 M35 M36;   
                    M14 M24 M34 M44 M45 M46;   
                    M15 M25 M35 M45 M55 M56;   
                    M16 M26 M36 M46 M56 M66];
%     2) 核心组件
            Tau_parts=-K2*de1-K3*e3-fn+dmiu-Gain_3*u_BLF1-diag([0.5;0.5])*u_BLF2; % Torque_parts: 2行1列
%     3) 六维输出
            Tau=M_66*[0;0;Tau_parts;0;0];
end

%% RBFNN权值计算
function NN = Dynamics_W(W,e13_com,e14_com,qd3,qd4,dqd3,dqd4,sq,dq)
global dt nodes Tau11 Tau12 eta1 b c K1 K2 rho_31 rho_32
e1_com=[e13_com;e14_com];
qd=[qd3;qd4]; 
dqd=[dqd3;dqd4];
e1=sq-qd;
% e1=q-(qd-.5*e1_com); % OK
miu=-K1*e1+dqd;
e2=dq-miu;
e3=K2*e1+e2;
u_BLF2_denominator_1=rho_31^2-e3(1)^2;
u_BLF2_denominator_2=rho_32^2-e3(2)^2;
u_BLF2=[e3(1)/u_BLF2_denominator_1;
        e3(2)/u_BLF2_denominator_2];
xi1=[sq(1);dq(1)];xi2=[sq(2);dq(2)];
h1=zeros(nodes,1);h2=zeros(nodes,1);
for j=1:1:nodes
    h1(j)=exp(-norm(xi1-c(:,j))^2/(b*b));
    h2(j)=exp(-norm(xi2-c(:,j))^2/(b*b));
end
W1=W(1:nodes,1);W2=W(nodes+1:2*nodes,1);
dW=zeros(2*nodes,1);
for i=1:1:nodes
    dW(i)=Tau11*h1(i)*u_BLF2(1)-eta1*W1(i); 
    dW(nodes+i)=Tau12*h2(i)*u_BLF2(2)-eta1*W2(i); 
end
NN=W+dW*dt;
end